{% extends 'base.html' %}
{% block content %}
<h2>Theme Catalog (Simple)</h2>
<div id="theme-catalog-simple">
  <div class="flex gap-3 flex-wrap mb-3.5 items-end">
    <div class="flex-1 min-w-[220px] relative">
      <label class="text-[11px] block opacity-70">Search</label>
      <input type="text" id="theme-search" placeholder="Search themes" aria-label="Search" class="w-full" autocomplete="off" />
      <div id="theme-search-results" class="search-suggestions"></div>
    </div>
    <div class="min-w-[160px]">
      <label class="text-[11px] block opacity-70">Popularity</label>
      <select id="pop-filter" class="w-full text-[13px]">
        <option value="">All</option>
        <option>Very Common</option>
        <option>Common</option>
        <option>Uncommon</option>
        <option>Niche</option>
        <option>Rare</option>
      </select>
    </div>
    <button id="clear-search" class="btn btn-ghost text-xs" hidden>Clear</button>
  </div>
  <div id="quick-popularity" class="flex gap-1.5 flex-wrap mb-2">
    {% for b in ['Very Common','Common','Uncommon','Niche','Rare'] %}
      <button class="btn btn-ghost pop-chip text-[11px] px-2 py-0.5" data-pop="{{ b }}">{{ b }}</button>
    {% endfor %}
  </div>
  <div id="active-filters" class="flex gap-1.5 flex-wrap mb-2 text-[11px]"></div>
  <div id="theme-results" aria-live="polite" aria-busy="true">
    <div class="flex flex-col gap-2">
      {% for i in range(6) %}<div class="skeleton-card"></div>{% endfor %}
    </div>
  </div>
</div>
<script>
(function(){
  const input = document.getElementById('theme-search');
  const resultsBox = document.getElementById('theme-search-results');
  const clearBtn = document.getElementById('clear-search');
  const popSel = document.getElementById('pop-filter');
  const popChips = document.querySelectorAll('.pop-chip');
  const activeFilters = document.getElementById('active-filters');
  const resultsHost = document.getElementById('theme-results');
  let lastQuery=''; let lastSearchIssued=0; const SEARCH_THROTTLE=150;
  let selectedIndex = -1;
  function hideResults(){ resultsBox.style.display='none'; resultsBox.innerHTML=''; selectedIndex = -1; }
  function buildParams(){
    const params = new URLSearchParams();
    const q = input.value.trim(); if(q) params.set('q', q);
    const pop = popSel.value; if(pop) params.set('bucket', pop);
    params.set('limit','50'); params.set('offset','0');
    return params.toString();
  }
  function addChip(label, remover){
    const span=document.createElement('span');
    span.className='filter-chip';
    span.innerHTML='<span>'+label+'</span><button class="filter-chip-remove" aria-label="Remove">×</button>';
    span.querySelector('button').addEventListener('click', remover);
    activeFilters.appendChild(span);
  }
  function renderActive(){
    activeFilters.innerHTML='';
    const q = input.value.trim(); if(q) addChip('Search: '+q, ()=>{ input.value=''; fetchList(); });
    const pop = popSel.value; if(pop) addChip('Popularity: '+pop, ()=>{ popSel.value=''; fetchList(); });
  }
  function fetchList(){
    const ps = buildParams();
    resultsHost.setAttribute('aria-busy','true');
    fetch('/themes/fragment/list_simple?'+ps, {cache:'no-store'})
      .then(r=>r.text())
      .then(html=>{
        resultsHost.innerHTML=html;
        if(window.htmx && typeof window.htmx.process==='function'){
          window.htmx.process(resultsHost);
        }
        resultsHost.removeAttribute('aria-busy');
        renderActive();
      })
      .catch(()=>{ resultsHost.innerHTML='<div class="empty" style="font-size:13px;">Failed to load.</div>'; resultsHost.removeAttribute('aria-busy'); });
  }
  function performSearch(q){
    if(!q){ hideResults(); return; }
    const now=Date.now(); if(now - lastSearchIssued < SEARCH_THROTTLE){ clearTimeout(window.__simpleSearchDelay); window.__simpleSearchDelay=setTimeout(()=>performSearch(q), SEARCH_THROTTLE); return; }
    lastSearchIssued=now; const issueId=lastSearchIssued;
    resultsBox.style.display='block';
    resultsBox.innerHTML='<div style="padding:.5rem; font-size:12px; opacity:.7;">Searching…</div>';
    fetch('/themes/api/search?q='+encodeURIComponent(q), {cache:'no-store'})
      .then(r=>r.json()).then(js=>{
        if(issueId!==lastSearchIssued) return;
        if(!js.ok){ hideResults(); return; }
        const items=js.items||[]; if(!items.length){ hideResults(); return; }
        resultsBox.innerHTML=items.map(it=>`<a href="/themes/${it.id}" data-theme-id="${it.id}">${it.theme}</a>`).join('');
        resultsBox.style.display='block';
        selectedIndex = -1;
      }).catch(()=>hideResults());
  }
  function getResultLinks(){ return Array.from(resultsBox.querySelectorAll('a[data-theme-id]')); }
  function selectResultItem(index){
    const links = getResultLinks();
    links.forEach((link, i) => {
      if (i === index) {
        link.classList.add('selected');
        link.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        link.classList.remove('selected');
      }
    });
    selectedIndex = index;
  }
  function applySelectedResult(){
    const links = getResultLinks();
    const link = links[selectedIndex];
    if (link) {
      window.location.href = link.href;
    }
  }
  input.addEventListener('input', function(){
    const q=this.value.trim(); clearBtn.hidden=!q; if(q!==lastQuery){ lastQuery=q; performSearch(q); fetchList(); }
  });
  input.addEventListener('keydown', function(ev){
    const links = getResultLinks();
    const hasResults = links.length > 0;
    
    if (ev.key === 'Escape' && hasResults) {
      hideResults();
      ev.preventDefault();
    } else if (ev.key === 'ArrowDown' && hasResults) {
      ev.preventDefault();
      const newIndex = selectedIndex < links.length - 1 ? selectedIndex + 1 : 0;
      selectResultItem(newIndex);
    } else if (ev.key === 'ArrowUp' && hasResults) {
      ev.preventDefault();
      const newIndex = selectedIndex > 0 ? selectedIndex - 1 : links.length - 1;
      selectResultItem(newIndex);
    } else if (ev.key === 'Enter' && selectedIndex >= 0 && hasResults) {
      ev.preventDefault();
      applySelectedResult();
    } else if(ev.key==='Enter' && ev.shiftKey){ const q=input.value.trim(); if(!q) return; ev.preventDefault(); fetch('/themes/api/search?q='+encodeURIComponent(q)+'&include_synergies=1',{cache:'no-store'}).then(r=>r.json()).then(js=>{ if(!js.ok) return; const items=js.items||[]; if(!items.length) return; resultsBox.innerHTML=items.map(it=>`<a href="/themes/${it.id}" data-theme-id="${it.id}">${it.theme} <span style=\"opacity:.55; font-size:10px;\">(w/ synergies)</span></a>`).join(''); resultsBox.style.display='block'; selectedIndex = -1; }); }
  });
  clearBtn.addEventListener('click', function(){ input.value=''; lastQuery=''; hideResults(); clearBtn.hidden=true; input.focus(); fetchList(); });
  resultsBox.addEventListener('click', function(ev){ const a=ev.target.closest('a[data-theme-id]'); if(!a) return; ev.preventDefault(); window.location.href='/themes/'+a.getAttribute('data-theme-id'); });
  resultsBox.addEventListener('mouseover', function(ev){ 
    const a=ev.target.closest('a[data-theme-id]'); 
    if(!a) return; 
    const links = getResultLinks();
    const index = links.indexOf(a);
    if (index >= 0) {
      selectResultItem(index);
    }
    const id=a.getAttribute('data-theme-id'); 
    if(!id || a._prefetched) return; 
    a._prefetched=true; 
    fetch('/themes/fragment/detail/'+id,{cache:'reload'}).catch(()=>{}); 
  });
  document.addEventListener('click', function(ev){ if(!resultsBox.contains(ev.target) && ev.target!==input){ hideResults(); } });
  popSel.addEventListener('change', fetchList); popChips.forEach(ch=> ch.addEventListener('click', ()=>{ popSel.value=ch.getAttribute('data-pop'); fetchList(); }));
  // Initial load
  fetchList();
})();
</script>
{% endblock %}